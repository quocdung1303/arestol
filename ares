#!/usr/bin/env python3
# CTOOL.py -- Full tool (menu, config, monitor) with ARES logo (green/yellow)
# T√≠ch h·ª£p WebSocket (asyncio), Logic C·∫ßu B·ªát, v√† Ph√≠m 'q' ƒë·ªÉ D·ª´ng.
#
# C√†i ƒë·∫∑t: pip install colorama websockets
# Ch·∫°y:     python3 CTOOL_full.py
#

import os
import re
import sys
import time
import json
import random
import asyncio  # Th√™m asyncio
import websockets # Th√™m websockets
from datetime import datetime
from colorama import Fore, Style, init
from collections import deque
# Threading ƒë·ªÉ l·∫Øng nghe ph√≠m 'q'
import threading

init(autoreset=True)

# ----------------- Config / Defaults -----------------
CONFIG_FILE = "config.json"

DEFAULT_CONFIG = {
    "user_id": "",
    "secret_key": "",
    "webhook": "",
    "send_webhook": False,
    "currency": "BUILD",
    "amount": 10,
    "multiplier": 1.0,
    "pause_after": 1,
    "pause_len": 1,
    "logic": 1,
    "auto_start_monitor": False,
    "bet_threshold": 4 # Ng∆∞·ª°ng c·∫ßu b·ªát
}

ROOM_NAMES = [
    "Nh√† kho", "Ph√≤ng h·ªçp", "Ph√≤ng Gi√°m ƒë·ªëc", "Ph√≤ng tr√≤ chuy·ªán",
    "Ph√≤ng Gi√°m s√°t", "VƒÉn ph√≤ng", "Ph√≤ng T√†i V·ª•", "Ph√≤ng Nh√¢n s·ª±"
]

# ----------------- ARES LOGO (green + yellow) -----------------
LOGO = f"""
{Fore.GREEN}    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
{Fore.YELLOW}               POWERED BY ARES TOOL
{Style.RESET_ALL}
"""

# ----------------- L·ªöP PH√ÇN T√çCH LOGIC C·∫¶U -----------------
class GameAnalyzer:
    def __init__(self, bet_threshold=4, history_size=20):
        self.BET_THRESHOLD = bet_threshold 
        self.history = deque(maxlen=history_size)
        self.current_streak_result = None
        self.current_streak_count = 0
        print(f"[Analyzer]: S·∫µn s√†ng! Ph√°t hi·ªán 'C·∫ßu B·ªát' >= {self.BET_THRESHOLD} v√°n.")

    def add_result(self, result):
        if not result:
            return
        self.history.append(result)
        print(f"[Analyzer]: Nh·∫≠n k·∫øt qu·∫£: {result}. L·ªãch s·ª≠: {list(self.history)}")
        self.check_bet_streak(result)
        self.check_1_1_pattern()

    def check_bet_streak(self, result):
        if result == self.current_streak_result:
            self.current_streak_count += 1
        else:
            self.current_streak_result = result
            self.current_streak_count = 1
            
        if self.current_streak_count == self.BET_THRESHOLD:
            print("\n" + Fore.RED + "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
            print(f"!!! C·∫¶U B·ªÜT: ƒêang b·ªát {self.current_streak_result}, {self.current_streak_count} v√°n!")
            print("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n" + Style.RESET_ALL)
        elif self.current_streak_count > self.BET_THRESHOLD:
            print(Fore.RED + f"--- (Ti·∫øp t·ª•c b·ªát {self.current_streak_result}: {self.current_streak_count} v√°n) ---" + Style.RESET_ALL)

    def check_1_1_pattern(self):
        if len(self.history) < 4:
            return
        last_4 = list(self.history)[-4:]
        if (last_4[0] == last_4[2] and 
            last_4[1] == last_4[3] and 
            last_4[0] != last_4[1]):
            print("\n" + Fore.CYAN + "*****************************************")
            print(f"!!! C·∫¶U 1-1: Ph√°t hi·ªán {last_4[0]}-{last_4[1]} (√≠t nh·∫•t 4 v√°n)")
            print("*****************************************\n" + Style.RESET_ALL)

# ----------------- Runtime state -----------------
state = {
    "chosen_room": None,
    "placed_amount": 0.0,
    "wins": 0,
    "losses": 0,
    "rounds": 0,
    "current_chain": 0,
    "max_chain": 0,
    "profit": 0.0,
    "sending": False,
    "current_rooms": [] # L∆∞u danh s√°ch ph√≤ng th·∫≠t
}

# ----------------- Utilities -----------------
def clear():
    os.system("cls" if os.name == "nt" else "clear")

def load_config():
    if os.path.isfile(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, "r", encoding="utf-8") as f:
                cfg = json.load(f)
            for k, v in DEFAULT_CONFIG.items():
                if k not in cfg:
                    cfg[k] = v
            return cfg
        except Exception:
            return DEFAULT_CONFIG.copy()
    else:
        return DEFAULT_CONFIG.copy()

def save_config(cfg):
    try:
        with open(CONFIG_FILE, "w", encoding="utf-8") as f:
            json.dump(cfg, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(Fore.RED + "L·ªói khi l∆∞u config:", e)

def parse_link_extract(link: str):
    uid = None
    skey = None
    m_uid = re.search(r"userId=([0-9]+)", link)
    if m_uid:
        uid = m_uid.group(1)
    m_key = re.search(r"secretKey=([0-9a-fA-F]+)", link)
    if m_key:
        skey = m_key.group(1)
    if not skey:
        m = re.search(r"([0-9a-f]{20,})", link, re.IGNORECASE)
        if m:
            skey = m.group(1)
    return uid, skey

# ----------------- UI components -----------------
def print_main_screen(cfg):
    clear()
    print(LOGO)
    print(Fore.BLUE + "YouTube".ljust(12) + ":" + Style.RESET_ALL, "https://www.youtube.com/@CTOOL")
    print(Fore.BLUE + "TikTok".ljust(12) + ":" + Style.RESET_ALL, "https://www.tiktok.com/@ctool7929")
    print(Fore.BLUE + "Zalo Group".ljust(12) + ":" + Style.RESET_ALL, "https://zalo.me/g/qowvzu729")
    print(Fore.BLUE + "Telegram".ljust(12) + ":" + Style.RESET_ALL, "https://t.me/+PByWNy8hDxYzYTRl")
    print(Fore.BLUE + "Admin".ljust(12) + ":" + Style.RESET_ALL, "Th√†nh C√¥ng\n")
    print(Fore.GREEN + "1. Tool vua tho√°t hi·ªÉm")
    print(Fore.GREEN + "2. C·∫•u h√¨nh t√†i kho·∫£n ch·∫°y tool")
    print(Fore.GREEN + "3. C·∫•u h√¨nh webhook")
    print(Fore.GREEN + "4. B·∫£ng gi√°m s√°t (ch·∫°y tool)")
    print(Fore.GREEN + "q. Tho√°t" + Style.RESET_ALL)
    print("\nNh·∫≠p : ", end="", flush=True)

def show_link_instructions():
    print(Fore.YELLOW + "H∆∞·ªõng d·∫´n l·∫•y link:" + Style.RESET_ALL)
    print(" 0. M·ªü chrome")
    print(" 1. Truy c·∫≠p website xworld.io")
    print(" 2. ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n")
    print(" 3. T√¨m v√† nh·∫•p v√†o Vua tho√°t hi·ªÉm")
    print(" 4. Nh·∫•n l·∫≠p t·ª©c truy c·∫≠p")
    print(" 5. Sao ch√©p link website v√† d√°n v√†o ƒë√¢y\n")

# ----------------- Logic to choose room -----------------
def choose_room_by_logic(rooms, logic):
    # rooms gi·ªù l√† danh s√°ch th·∫≠t t·ª´ server
    if not rooms:
        return None
        
    if logic == 1:
        return random.choice(rooms)
    if logic == 2:
        return rooms[0]
    if logic == 3: # Gi·∫£ s·ª≠ rooms c√≥ 'money'
        return max(rooms, key=lambda r: r.get("money", 0))
    if logic == 4: # Gi·∫£ s·ª≠ rooms c√≥ 'money'
        return min(rooms, key=lambda r: r.get("money", 0))
    # fallback: random
    return random.choice(rooms)

# ----------------- Monitor / UI table -----------------
def print_table(rooms, cfg):
    # H√†m n√†y b√¢y gi·ªù d√πng state["current_rooms"]
    print(Fore.CYAN + f"CTOOL-B·∫£ng gi√°m s√°t (Connecting...)" + Style.RESET_ALL)
    print("-" * 74)
    print("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
    print("‚îÇ STT‚îÇ Ph√≤ng                ‚îÇ S·ªë ng∆∞·ªùi ‚îÇ S·ªë ti·ªÅn    ‚îÇ TH√îNG TIN                   ‚îÇ")
    print("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
    
    if not rooms:
        print(f"‚îÇ {''.ljust(72)} ‚îÇ")
        print(f"‚îÇ {Fore.YELLOW}{'ƒêang ch·ªù d·ªØ li·ªáu ph√≤ng t·ª´ WebSocket...'.center(72)}{Style.RESET_ALL} ‚îÇ")
        
    for r in rooms:
        # PH·∫¢I S·ª¨A: Thay 'stt', 'name', 'people', 'money' b·∫±ng key th·∫≠t
        stt = str(r.get("stt", r.get("id", "?"))).rjust(2)
        name = str(r.get("name", "N/A"))[:20].ljust(20)
        people = str(r.get("people", 0)).rjust(8)
        money = f"{r.get('money', 0):,.2f}".rjust(10)
        
        chosen = (state["chosen_room"] is not None and state["chosen_room"].get("id") == r.get("id"))
        
        info_lines = []
        info_lines.append(f"LOGIC:{cfg['logic']}")
        if chosen:
            info_lines.append(f"Ph√≤ng ƒë√£ v√†o:{stt}")
            info_lines.append(f"ƒê√£ ƒë·∫∑t:{int(state['placed_amount']) if cfg['currency']=='BUILD' else state['placed_amount']}")
            info_lines.append(f"Tr·∫≠n th·∫Øng:{state['wins']}/{state['rounds']}")
            info_lines.append(f"Chu·ªói:{state['current_chain']}")
            info_lines.append(f"Max:{state['max_chain']}")
            info_lines.append(f"L·ªùi:{state['profit']:.2f}")
            info_lines.append(f"Wb:{state['sending']}")
        info = "; ".join(info_lines)
        if len(info) > 26:
            info = info[:26] + "‚Ä¶"
        print(f"‚îÇ {stt} ‚îÇ {name} ‚îÇ {people} ‚îÇ {money} ‚îÇ {Fore.CYAN}{info.ljust(26)}{Style.RESET_ALL} ‚îÇ")
    
    print("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
    print()
    print(Fore.GREEN + "---C·∫•u h√¨nh c·ªßa b·∫°n---" + Style.RESET_ALL)
    print(f"Lo·∫°i ti·ªÅn: {cfg['currency']}")
    print(f"S·ªë {cfg['currency']} ƒë·∫∑t cho m·ªói v√°n: {cfg['amount']}")
    print(f"H·ªá s·ªë: {cfg['multiplier']}")
    print(f"Logic: {cfg['logic']}")
    print(f"Sau khi ch∆°i {cfg['pause_after']} th√¨ ngh·ªâ {cfg['pause_len']} v√°n")
    print("-" * 74)
    print(f"{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  Rounds:{state['rounds']}  Wins:{state['wins']}  Losses:{state['losses']}  Profit:{state['profit']:.2f} {cfg['currency']}")

# ----------------- PH·∫¶N CH·∫†Y TH·∫¨T (WEBSOCKET) -----------------

def listen_for_quit(stop_event: asyncio.Event):
    """
    (H√†m n√†y ch·∫°y ·ªü lu·ªìng ph·ª•)
    Ch·ªù ng∆∞·ªùi d√πng nh·∫≠p 'q' ƒë·ªÉ d·ª´ng.
    """
    print(Fore.CYAN + "\n[CONTROL]: Nh·∫•n 'q' r·ªìi Enter b·∫•t c·ª© l√∫c n√†o ƒë·ªÉ D·ª™NG v√† quay v·ªÅ menu." + Style.RESET_ALL)
    try:
        # Ch·ªù input() ·ªü lu·ªìng n√†y (kh√¥ng ·∫£nh h∆∞·ªüng asyncio)
        key = input() 
        if key.strip().lower() == 'q':
            if not stop_event.is_set():
                print(Fore.YELLOW + "[CONTROL]: ƒê√£ nh·∫≠n 'q', ƒëang y√™u c·∫ßu d·ª´ng..." + Style.RESET_ALL)
                # ƒê·∫∑t t√≠n hi·ªáu ƒë·ªÉ b√°o cho lu·ªìng async
                stop_event.set()
    except EOFError:
        # X·∫£y ra khi ch∆∞∆°ng tr√¨nh b·ªã ng·∫Øt ƒë·ªôt ng·ªôt
        pass 

async def websocket_receiver(websocket, cfg, analyzer):
    """
    (H√†m Async) Ch·ªâ l√†m nhi·ªám v·ª• nh·∫≠n v√† x·ª≠ l√Ω tin nh·∫Øn.
    """
    async for message in websocket:
        try:
            data = json.loads(message)
            
            # In ra ƒë·ªÉ debug (b·∫°n c√≥ th·ªÉ t·∫Øt sau)
            print(Fore.MAGENTA + f"[RECV]: {json.dumps(data, indent=2)}" + Style.RESET_ALL)
            
            # ----------------------------------------------------
            # === !!! PH·∫¶N B·∫†N C·∫¶N S·ª¨A (QUAN TR·ªåNG) !!! ===
            # ----------------------------------------------------
            # (Logic v√≠ d·ª• c·ªßa b·∫°n ƒë·∫øn ƒë√¢y)

            # V√ç D·ª§: N·∫øu nh·∫≠n ƒë∆∞·ª£c danh s√°ch ph√≤ng
            # if data.get('type') == 'room_list':
            #    state["current_rooms"] = data.get('rooms', [])
            #    
            #    # Ch·ªçn ph√≤ng theo logic
            #    chosen_room = choose_room_by_logic(state["current_rooms"], cfg['logic'])
            #    if chosen_room:
            #        state["chosen_room"] = chosen_room
            #        
            #        # G·ª≠i tin nh·∫Øn ƒë·∫∑t c∆∞·ª£c
            #        bet_payload = { ... }
            #        await websocket.send(json.dumps(bet_payload))
            #        ...

            # V√ç D·ª§: N·∫øu nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ v√°n
            # if data.get('type') == 'game_result':
            #    ... (C·∫≠p nh·∫≠t state, profit, wins, losses) ...
            #    
            #    # L·∫•y k·∫øt qu·∫£ (V√ç D·ª§: "T√†i", "X·ªâu")
            #    result_value = data.get('result_name') 
            #    analyzer.add_result(result_value)
            #
            #    # Y√™u c·∫ßu danh s√°ch ph√≤ng cho v√°n m·ªõi
            #    await asyncio.sleep(1) # Ch·ªù 1s
            #    await websocket.send(json.dumps({"type": "get_rooms"}))

            # C·∫≠p nh·∫≠t giao di·ªán (v·∫Ω l·∫°i b·∫£ng)
            clear()
            print(LOGO)
            print_table(state["current_rooms"], cfg)


        except json.JSONDecodeError:
            print(f"\n[Server-Text]: {message}")
        except Exception as e:
            print(f"L·ªói khi x·ª≠ l√Ω tin nh·∫Øn: {e}")

async def websocket_main_loop(cfg, stop_event: asyncio.Event):
    """
    (H√†m Async) V√≤ng l·∫∑p ch√≠nh, qu·∫£n l√Ω k·∫øt n·ªëi,
    ch·∫°y b·ªô l·∫Øng nghe (receiver) v√† b·ªô d·ª´ng (stop listener).
    """
    analyzer = GameAnalyzer(bet_threshold=cfg.get("bet_threshold", 4))
    
    URI = "wss://escapemaster.net/" # C√ì TH·ªÇ C·∫¶N TH√äM PATH
    HEADERS = {
        "Origin": "https://escapemaster.net",
        "User-Agent": "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Mobile Safari/537.36",
        "X-User-ID": cfg.get("user_id", ""),
        "X-Secret-Key": cfg.get("secret_key", "")
    }
    
    # Kh·ªüi ƒë·ªông lu·ªìng nghe ph√≠m 'q'
    # Ph·∫£i d√πng 'asyncio.to_thread' (Python 3.9+) ho·∫∑c 'run_in_executor'
    loop = asyncio.get_running_loop()
    loop.run_in_executor(None, listen_for_quit, stop_event)
    
    # V√≤ng l·∫∑p t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i, CH·ªà D·ª™NG khi c√≥ t√≠n hi·ªáu 'q'
    while not stop_event.is_set():
        try:
            clear()
            print(LOGO)
            print_table(state["current_rooms"], cfg)
            print(Fore.YELLOW + f"ƒêang k·∫øt n·ªëi t·ªõi {URI} v·ªõi UserID: {cfg.get('user_id')}" + Style.RESET_ALL)
            
            async with websockets.connect(
                URI, 
                extra_headers=HEADERS,
                ping_interval=20,
                ping_timeout=20
            ) as websocket:
                
                print(Fore.GREEN + "\n=== K·∫æT N·ªêI TH√ÄNH C√îNG! ===" + Style.RESET_ALL)
                
                # TODO: G·ª≠i tin nh·∫Øn x√°c th·ª±c (n·∫øu c·∫ßn)
                
                # TODO: G·ª≠i tin nh·∫Øn y√™u c·∫ßu danh s√°ch ph√≤ng
                
                # Ch·∫°y 2 t√°c v·ª• song song:
                # 1. recv_task: Nh·∫≠n tin nh·∫Øn t·ª´ server
                # 2. stop_task: Ch·ªù t√≠n hi·ªáu 'q'
                
                recv_task = asyncio.create_task(
                    websocket_receiver(websocket, cfg, analyzer)
                )
                stop_task = asyncio.create_task(stop_event.wait())
                
                # Ch·ªù 1 trong 2 t√°c v·ª• ho√†n th√†nh
                done, pending = await asyncio.wait(
                    [recv_task, stop_task], 
                    return_when=asyncio.FIRST_COMPLETED
                )
                
                # H·ªßy c√°c t√°c v·ª• c√≤n l·∫°i
                for task in pending:
                    task.cancel()

                if stop_task in done:
                    # N·∫øu 'q' ƒë∆∞·ª£c nh·∫•n, tho√°t v√≤ng l·∫∑p k·∫øt n·ªëi
                    print(Fore.YELLOW + "ƒê√£ nh·∫≠n t√≠n hi·ªáu d·ª´ng, ng·∫Øt k·∫øt n·ªëi..." + Style.RESET_ALL)
                    break 
                
                # N·∫øu recv_task_done (t·ª©c l√† websocket b·ªã ng·∫Øt k·∫øt n·ªëi),
                # v√≤ng l·∫∑p 'while' s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i ƒë·ªÉ k·∫øt n·ªëi l·∫°i.

        except websockets.exceptions.ConnectionClosedError as e:
            if stop_event.is_set(): break
            print(Fore.RED + f"L·ªñI: M·∫•t k·∫øt n·ªëi (Code: {e.code}). Th·ª≠ l·∫°i sau 5s..." + Style.RESET_ALL)
            await asyncio.sleep(5)
        except Exception as e:
            if stop_event.is_set(): break
            print(Fore.RED + f"L·ªói kh√¥ng x√°c ƒë·ªãnh: {e}. Th·ª≠ l·∫°i sau 5s..." + Style.RESET_ALL)
            await asyncio.sleep(5)
    
    print("ƒê√£ d·ª´ng B·∫£ng Gi√°m S√°t.")


# ----------------- Monitor main loop (ƒê√É S·ª¨A) -----------------
def run_monitor(cfg):
    # T·∫°o t√≠n hi·ªáu D·ª™NG
    stop_event = asyncio.Event()
    
    try:
        # Ch·∫°y v√≤ng l·∫∑p async
        asyncio.run(websocket_main_loop(cfg, stop_event))
    except KeyboardInterrupt:
        # X·ª≠ l√Ω Ctrl+C (fallback)
        print("\n" + Fore.YELLOW + "ƒê√£ d·ª´ng (Ctrl+C). Quay l·∫°i menu ch√≠nh." + Style.RESET_ALL)
        time.sleep(0.6)

# ----------------- Configuration flows (GI·ªÆ NGUY√äN) -----------------
def configure_account_flow(cfg):
    clear()
    print(LOGO)
    print(Fore.YELLOW + "---C·∫•u h√¨nh t√†i kho·∫£n ch·∫°y tool---" + Style.RESET_ALL)
    print()
    show_link_instructions()
    link = input(Fore.YELLOW + "üìã Nh·∫≠p li√™n k·∫øt c·ªßa b·∫°n (paste link Vua tho√°t hi·ªÉm): " + Style.RESET_ALL).strip()
    if link:
        uid, skey = parse_link_extract(link)
        if uid:
            cfg["user_id"] = uid
            print(Fore.GREEN + "Your user id is" + Style.RESET_ALL, uid)
        else:
            print(Fore.YELLOW + "Kh√¥ng t√¨m th·∫•y userId trong link.")
        if skey:
            cfg["secret_key"] = skey
            print(Fore.GREEN + "Your user secret key is" + Style.RESET_ALL, skey[:40] + "...")
        else:
            print(Fore.YELLOW + "Kh√¥ng t√¨m th·∫•y secretKey trong link.")
    else:
        uid = input("Nh·∫≠p user id (ho·∫∑c Enter ƒë·ªÉ b·ªè qua): ").strip()
        if uid:
            cfg["user_id"] = uid
        sk = input("Nh·∫≠p secret key (ho·∫∑c Enter ƒë·ªÉ b·ªè qua): ").strip()
        if sk:
            cfg["secret_key"] = sk

    print()
    print("1. BUILD\n2. USDT\n3. WORLD")
    while True:
        c = input(Fore.YELLOW + "Ch·ªçn lo·∫°i ti·ªÅn b·∫°n mu·ªën ch∆°i (1/2/3): " + Style.RESET_ALL).strip()
        if c in ("1","2","3"):
            cfg["currency"] = {"1":"BUILD","2":"USDT","3":"WORLD"}[c]
            break
        else:
            print("Nh·∫≠p 1/2/3.")
    while True:
        v = input(Fore.YELLOW + f"Nh·∫≠p s·ªë l∆∞·ª£ng {cfg['currency']} ƒë·ªÉ ƒë·∫∑t (vd 10): " + Style.RESET_ALL).strip()
        try:
            val = float(v)
            if val > 0:
                cfg["amount"] = val
                break
        except:
            pass
        print("Nh·∫≠p s·ªë h·ª£p l·ªá > 0.")
    while True:
        v = input(Fore.YELLOW + "Nh·∫≠p h·ªá s·ªë c∆∞·ª£c sau khi thua (vd 1): " + Style.RESET_ALL).strip()
        try:
            cfg["multiplier"] = float(v)
            break
        except:
            print("Nh·∫≠p s·ªë h·ª£p l·ªá.")
    while True:
        v = input(Fore.YELLOW + "Sau bao nhi√™u v√°n th√¨ t·∫°m ngh·ªâ (999 n·∫øu kh√¥ng mu·ªën t·∫°m ngh·ªâ): " + Style.RESET_ALL).strip()
        try:
            cfg["pause_after"] = int(v)
            break
        except:
            print("Nh·∫≠p s·ªë nguy√™n.")
    while True:
        v = input(Fore.YELLOW + "Sau ƒë√≥ t·∫°m ngh·ªâ bao nhi√™u v√°n (0 n·∫øu kh√¥ng mu·ªën ngh·ªâ): " + Style.RESET_ALL).strip()
        try:
            cfg["pause_len"] = int(v)
            break
        except:
            print("Nh·∫≠p s·ªë nguy√™n.")
    print()
    print(Fore.GREEN + "Ch·ªçn Logic (1..4). 1=Random, 2=Ph√≤ng ƒë·∫ßu, 3=Nhi·ªÅu ti·ªÅn, 4=√çt ti·ªÅn" + Style.RESET_ALL)
    while True:
        v = input(Fore.YELLOW + "Nh·∫≠p STT logic c·∫ßn d√πng: " + Style.RESET_ALL).strip()
        if v.isdigit() and 1 <= int(v) <= 4: # S·ª≠a logic
            cfg["logic"] = int(v)
            break
        else:
            print("Nh·∫≠p 1..4.")
    print()
    w = input(Fore.YELLOW + "Nh·∫≠p webhook URL (Enter ƒë·ªÉ b·ªè qua): " + Style.RESET_ALL).strip()
    if w:
        cfg["webhook"] = w
        cfg["send_webhook"] = input("B·∫≠t g·ª≠i webhook? (y/n): ").strip().lower() == "y"
    save_config(cfg)
    print(Fore.GREEN + "ƒê√£ l∆∞u c·∫•u h√¨nh v√†o config.json" + Style.RESET_ALL)
    input("Nh·∫•n Enter ƒë·ªÉ quay l·∫°i menu...")

def configure_webhook(cfg):
    clear()
    print(LOGO)
    print(Fore.YELLOW + "---C·∫•u h√¨nh webhook---" + Style.RESET_ALL)
    w = input("Webhook URL: ").strip()
    if w:
        cfg["webhook"] = w
    cfg["send_webhook"] = input("B·∫≠t g·ª≠i webhook? (y/n): ").strip().lower() == "y"
    save_config(cfg)
    print("ƒê√£ l∆∞u.")
    input("Nh·∫•n Enter ...")

# ----------------- Main program (GI·ªÆ NGUY√äN) -----------------
def main():
    cfg = load_config()
    while True:
        print_main_screen(cfg)
        ch = input().strip().lower()
        if ch == "1":
            print("\n>> Loading..\n")
            time.sleep(0.4)
            # input("Nh·∫•n Enter ƒë·ªÉ b·∫Øt ƒë·∫ßu gi√°m s√°t (Ctrl-C ƒë·ªÉ d·ª´ng)...") # B·ªè d√≤ng n√†y
            run_monitor(cfg)
        elif ch == "2":
            configure_account_flow(cfg)
        elif ch == "3":
            configure_webhook(cfg)
        elif ch == "4":
            run_monitor
